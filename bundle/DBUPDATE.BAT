@ECHO OFF

ECHO ==========================Ag Group RK6 DBUpdate Utility=========================>> %LOGFILE%
TIMENOW >> %LOGFILE%

ECHO Compare %BUNDLEDIR%\%RKTYPE%.zip MD5... >> %LOGFILE%
TYPE %UNZIPDIR%\%MD5% | FAM /M1=%BUNDLE%.zip \F0 | TR a-f A-F | PIPESET NEWMD5
MD5 %BUNDLEDIR%\%RKTYPE%.zip | FAM \F3 | TR a-f A-F | PIPESET OLDMD5
IF "%NEWMD5%" == "%OLDMD5%" GOTO DBMD5OK

ECHO Update DHCP lease >> %LOGFILE%
DHCP
IF %ERRORLEVEL% == 0 GOTO DHCPOK
ECHO START DHCP: ERROR >> %LOGFILE%
GOTO END

:DHCPOK
ECHO START DHCP: OK >> %LOGFILE%
ECHO Getting %RKTYPE%.zip from %SERVER%... >> %LOGFILE%
HTGET %SERVER%/%RKTYPE%.zip > %BUNDLEDIR%\%RKTYPE%.zip
IF %ERRORLEVEL% == 21 GOTO DBZGETOK

ECHO Cannot get %RKTYPE%.zip... >> %LOGFILE%
GOTO END

:DBZGETOK
ECHO Getting successfully %RKTYPE%.zip from %SERVER%... >> %LOGFILE%
ECHO Compare %BUNDLEDIR%\%RKTYPE%.zip MD5... >> %LOGFILE%
TYPE %UNZIPDIR%\%MD5% | FAM /M1=%BUNDLE%.zip \F0 | TR a-f A-F | PIPESET NEWMD5
MD5 %BUNDLEDIR%\%RKTYPE%.zip | FAM \F3 | TR a-f A-F | PIPESET OLDMD5
IF "%NEWMD5%" == "%OLDMD5%" GOTO DBMD5OK

ECHO MD5 Verification faild: %NEWMD5% ne %OLDMD5% >> %LOGFILE%
GOTO END

:DBMD5OK
ECHO MD5 Verification successfully: %NEWMD5% eq %OLDMD5% >> %LOGFILE%
ECHO Unzip %BUNDLEDIR%\%RKTYPE%.zip to %DBDIR% >> %LOGFILE%
UNZIP32 -o %BUNDLEDIR%\%RKTYPE%.zip -d %DBDIR%
IF %ERRORLEVEL% == 0 GOTO UNZIPOK

ECHO Unzip %BUNDLEDIR%\%RKTYPE%.zip to %DBDIR%: ERROR >> %LOGFILE%
GOTO END

:UNZIPOK
ECHO Unzip %BUNDLEDIR%\%RKTYPE%.zip to %DBDIR%: OK >> %LOGFILE%

:END
TIMENOW >> %LOGFILE%
ECHO ===============================DBUPDATE COMPLETED===============================>> %LOGFILE%
ECHO.