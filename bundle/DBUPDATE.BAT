@ECHO OFF

ECHO ==========================Ag Group RK6 DBUpdate Utility=========================>> %LOGFILE%
TIMENOW >> %LOGFILE%

ECHO Compare %BUNDLEDIR%\%RKTYPE%.zip CRC32... >> %LOGFILE%
TYPE %CRCDIR%\%RKTYPE%.c32 | TR a-f A-F | PIPESET NEWCRC
CRC32 %BUNDLEDIR%\%RKTYPE%.zip | FAM \F1 | TR a-f A-F | PIPESET OLDCRC
IF "%NEWCRC%" == "%OLDCRC%" GOTO DBCRCOK

ECHO Update DHCP lease >> %LOGFILE%
DHCP
IF %ERRORLEVEL% == 0 GOTO DHCPOK
ECHO START DHCP: ERROR >> %LOGFILE%
GOTO END

:DHCPOK
ECHO START DHCP: OK >> %LOGFILE%
ECHO Getting %RKTYPE%.zip from %SERVER%... >> %LOGFILE%
HTGET %SERVER%/%RKTYPE%.zip > %BUNDLEDIR%\%RKTYPE%.zip
IF %ERRORLEVEL% == 21 GOTO DBZGETOK

ECHO Cannot get %RKTYPE%.zip... >> %LOGFILE%
GOTO END

:DBZGETOK
ECHO Compare %BUNDLEDIR%\%RKTYPE%.zip CRC32... >> %LOGFILE%
TYPE %CRCDIR%\%RKTYPE%.c32 | TR a-f A-F | PIPESET NEWCRC
CRC32 %BUNDLEDIR%\%RKTYPE%.zip | FAM \F1 | TR a-f A-F | PIPESET OLDCRC
IF "%NEWCRC%" == "%OLDCRC%" GOTO DBCRCOK

ECHO CRC32 Verification faild: %NEWCRC% ne %OLDCRC% >> %LOGFILE%
GOTO END

:DBCRCOK
ECHO CRC32 Verification successfully: %NEWCRC% eq %OLDCRC% >> %LOGFILE%
ECHO Unzip %BUNDLEDIR%\%RKTYPE%.zip to %DBDIR% >> %LOGFILE%
UNZIP32 -o %BUNDLEDIR%\%RKTYPE%.zip -d %DBDIR%
IF %ERRORLEVEL% == 0 GOTO UNZIPOK

ECHO Unzip %BUNDLEDIR%\%RKTYPE%.zip to %DBDIR%: ERROR >> %LOGFILE%
GOTO END

:UNZIPOK
ECHO Unzip %BUNDLEDIR%\%RKTYPE%.zip to %DBDIR%: OK >> %LOGFILE%

:END
TIMENOW >> %LOGFILE%
ECHO ===============================DBUPDATE COMPLETED===============================>> %LOGFILE%
ECHO.